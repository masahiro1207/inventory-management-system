<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>在庫管理システム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #00d4ff;
        --secondary-color: #0099cc;
        --accent-color: #ff6b35;
        --success-color: #00ff88;
        --warning-color: #ffaa00;
        --danger-color: #ff4757;
        --dark-bg: #0a0a0a;
        --dark-card: #1a1a1a;
        --dark-surface: #2a2a2a;
        --text-primary: #ffffff;
        --text-secondary: #b0b0b0;
        --text-muted: #808080;
        --border-color: #333333;
      }

      body {
        background: linear-gradient(
          135deg,
          #0a0a0a 0%,
          #1a1a1a 50%,
          #0a0a0a 100%
        );
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text-primary);
      }

      .navbar {
        background: rgba(26, 26, 26, 0.95) !important;
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--accent-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .main-container {
        background: rgba(26, 26, 26, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        margin: 2rem auto;
        padding: 2rem;
        max-width: 1400px;
        border: 1px solid var(--border-color);
      }

      .card {
        background: var(--dark-card);
        border: 1px solid var(--border-color);
        border-radius: 15px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        overflow: hidden;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
        border-color: var(--primary-color);
      }

      .card-header {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding: 1.5rem;
        font-weight: 600;
      }

      .btn {
        border-radius: 10px;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .btn:hover::before {
        left: 100%;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: var(--dark-bg);
      }

      .btn-success {
        background: linear-gradient(135deg, var(--success-color), #00cc6a);
        color: var(--dark-bg);
      }

      .btn-warning {
        background: linear-gradient(135deg, var(--warning-color), #e69500);
        color: var(--dark-bg);
      }

      .btn-danger {
        background: linear-gradient(135deg, var(--danger-color), #ff3742);
        color: var(--text-primary);
      }

      .btn-outline-light {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        background: transparent;
      }

      .btn-outline-light:hover {
        background: var(--primary-color);
        color: var(--dark-bg);
      }

      .table {
        background: var(--dark-card);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border-color);
      }

      .table thead th {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        color: var(--text-primary);
        border: none;
        padding: 1rem;
        font-weight: 600;
        border-bottom: 2px solid var(--primary-color);
      }

      .table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid var(--border-color);
      }

      .table tbody tr:hover {
        background-color: rgba(0, 212, 255, 0.1);
        transform: scale(1.01);
      }

      .table tbody td {
        color: var(--dark-card);
        border-color: var(--border-color);
        padding: 1rem;
      }

      .stock-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
      }

      .stock-controls .btn {
        width: 40px;
        height: 40px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
      }

      .stock-display {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        min-width: 80px;
        text-align: center;
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .stock-low {
        background: linear-gradient(135deg, #2a1a1a, #1a0a0a);
        border-color: var(--danger-color);
        color: var(--danger-color);
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
      }

      .stock-ok {
        background: linear-gradient(135deg, #1a2a1a, #0a1a0a);
        border-color: var(--success-color);
        color: var(--success-color);
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
      }

      .min-quantity-btn {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .min-quantity-btn:hover {
        background: linear-gradient(
          135deg,
          var(--dark-card),
          var(--dark-surface)
        );
        border-color: var(--primary-color);
        transform: scale(1.05);
      }

      .delete-btn {
        background: linear-gradient(135deg, var(--danger-color), #ff3742);
        color: var(--text-primary);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .delete-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
      }

      .alert-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 300px;
      }

      .alert {
        background: var(--dark-card);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        color: var(--text-primary);
        font-size: 0.9rem;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
      }

      .recommendation-card {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        border-left: 5px solid;
        transition: all 0.3s ease;
      }

      .priority-high {
        border-left-color: var(--danger-color);
      }
      .priority-medium {
        border-left-color: var(--warning-color);
      }
      .priority-low {
        border-left-color: var(--success-color);
      }

      .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(26, 26, 26, 0.5);
      }

      .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(0, 212, 255, 0.1);
      }

      .upload-area.dragover {
        border-color: var(--success-color);
        background: rgba(0, 255, 136, 0.1);
      }

      .stats-card {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
      }

      .stats-card:hover {
        transform: translateY(-5px);
        border-color: var(--primary-color);
      }

      .stats-number {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--accent-color)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .stats-label {
        color: var(--text-secondary);
        font-weight: 500;
      }

      .search-controls {
        background: var(--dark-surface);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
      }

      .form-control,
      .form-select {
        background: var(--dark-card);
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        color: var(--text-primary);
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        background: var(--dark-card);
        color: var(--text-primary);
      }

      .form-control::placeholder {
        color: var(--text-muted);
      }

      .modal-content {
        background: var(--dark-card);
        border-radius: 20px;
        border: 1px solid var(--border-color);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }

      .modal-header {
        background: linear-gradient(
          135deg,
          var(--dark-surface),
          var(--dark-card)
        );
        color: var(--text-primary);
        border-radius: 20px 20px 0 0;
        border-bottom: 1px solid var(--border-color);
      }

      .modal-body {
        color: var(--text-primary);
      }

      .modal-footer {
        border-top: 1px solid var(--border-color);
      }

      .badge {
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 600;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dealer-filter {
        background: var(--dark-surface);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0.5rem 1rem;
        color: var(--text-primary);
        transition: all 0.3s ease;
      }

      .dealer-filter:hover {
        border-color: var(--primary-color);
      }

      .sort-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .sort-controls select {
        background: var(--dark-card);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        border-radius: 8px;
        padding: 0.5rem;
      }

      .glow-effect {
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
      }

      .glow-effect:hover {
        box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
      }

      /* レスポンシブデザイン */
      @media (max-width: 768px) {
        .main-container {
          margin: 1rem;
          padding: 1rem;
          border-radius: 15px;
        }

        .navbar-brand {
          font-size: 1.2rem;
        }

        .navbar-nav {
          flex-direction: column;
          gap: 0.5rem;
        }

        .navbar-nav .btn {
          font-size: 0.9rem;
          padding: 0.5rem 1rem;
        }

        .stats-card {
          margin-bottom: 1rem;
          padding: 1rem;
        }

        .stats-number {
          font-size: 1.5rem;
        }

        .search-controls {
          flex-direction: column;
          gap: 1rem;
        }

        .search-controls .row {
          margin: 0;
        }

        .search-controls .col-md-4,
        .search-controls .col-md-3 {
          margin-bottom: 1rem;
        }

        .table-responsive {
          border-radius: 10px;
          overflow-x: auto;
        }

        .table {
          font-size: 0.9rem;
        }

        .table th,
        .table td {
          padding: 0.5rem 0.3rem;
          white-space: nowrap;
        }

        .btn {
          padding: 0.4rem 0.8rem;
          font-size: 0.85rem;
        }

        .btn-sm {
          padding: 0.25rem 0.5rem;
          font-size: 0.8rem;
        }

        .min-quantity-container,
        .category-container {
          min-width: 60px;
        }

        .min-quantity-display,
        .category-display {
          padding: 0.2rem 0.4rem;
          font-size: 0.8rem;
          min-width: 35px;
        }

        .min-quantity-input,
        .category-select {
          width: 50px;
          font-size: 0.8rem;
          padding: 0.2rem 0.4rem;
        }

        .stock-controls {
          display: flex;
          align-items: center;
          gap: 0.3rem;
        }

        .stock-controls .btn {
          padding: 0.2rem 0.4rem;
          font-size: 0.7rem;
          min-width: 30px;
        }

        .stock-display {
          font-size: 0.9rem;
          padding: 0.2rem 0.4rem;
          min-width: 40px;
        }
      }

      @media (max-width: 576px) {
        .main-container {
          margin: 0.5rem;
          padding: 0.8rem;
        }

        .navbar-brand {
          font-size: 1rem;
        }

        .stats-number {
          font-size: 1.2rem;
        }

        .table {
          font-size: 0.8rem;
        }

        .table th,
        .table td {
          padding: 0.3rem 0.2rem;
        }

        .btn {
          padding: 0.3rem 0.6rem;
          font-size: 0.8rem;
        }

        .btn-sm {
          padding: 0.2rem 0.4rem;
          font-size: 0.75rem;
        }
      }

      /* タッチ操作最適化 */
      @media (max-width: 768px) {
        .btn {
          min-height: 44px;
          min-width: 44px;
          touch-action: manipulation;
        }

        .btn-sm {
          min-height: 36px;
          min-width: 36px;
        }

        .form-control,
        .form-select {
          min-height: 44px;
          font-size: 16px; /* iOS ズーム防止 */
        }

        .table th,
        .table td {
          padding: 0.75rem 0.5rem;
          vertical-align: middle;
        }

        .stock-controls {
          justify-content: center;
          gap: 0.5rem;
        }

        .stock-controls .btn {
          min-width: 40px;
          min-height: 40px;
          border-radius: 50%;
        }

        .stock-display {
          min-width: 50px;
          text-align: center;
          font-weight: bold;
          font-size: 1rem;
        }

        .mobile-sort-controls .form-select {
          font-size: 14px;
          padding: 0.5rem;
        }

        /* スワイプ操作のためのスクロール最適化 */
        .table-responsive {
          -webkit-overflow-scrolling: touch;
          scroll-behavior: smooth;
        }

        /* タップ時の視覚的フィードバック */
        .btn:active {
          transform: scale(0.95);
          transition: transform 0.1s ease;
        }

        /* 長いテキストの省略表示 */
        .text-truncate {
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }

        /* モバイル用カード形式の在庫一覧 */
        .mobile-inventory-card {
          background: var(--dark-card);
          border: 1px solid var(--border-color);
          border-radius: 10px;
          padding: 1rem;
          margin-bottom: 0.75rem;
          transition: all 0.3s ease;
        }

        .mobile-inventory-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .mobile-product-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 0.75rem;
        }

        .mobile-product-name {
          font-weight: bold;
          font-size: 1rem;
          color: var(--text-primary);
          margin: 0;
          flex: 1;
          margin-right: 0.5rem;
        }

        .mobile-manufacturer {
          font-size: 0.85rem;
          color: var(--text-secondary);
          margin: 0;
        }

        .mobile-product-details {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
        }

        .mobile-category {
          background: var(--primary-color);
          color: white;
          padding: 0.25rem 0.5rem;
          border-radius: 15px;
          font-size: 0.75rem;
          font-weight: 500;
        }

        .mobile-stock-controls {
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .mobile-stock-display {
          font-size: 1.1rem;
          font-weight: bold;
          min-width: 40px;
          text-align: center;
        }

        .mobile-stock-display.stock-low {
          color: #ff6b6b;
        }

        .mobile-stock-display.stock-ok {
          color: #51cf66;
        }
      }

      /* 取引会社タブスタイル */
      .dealer-tabs {
        background: var(--dark-card);
        border-radius: 10px;
        padding: 1rem;
        border: 1px solid var(--border-color);
      }

      .dealer-tabs .nav-tabs {
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 0;
      }

      .dealer-tabs .nav-tabs .nav-link {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        border-radius: 8px 8px 0 0;
        margin-right: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        position: relative;
      }

      .dealer-tabs .nav-tabs .nav-link:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
      }

      .dealer-tabs .nav-tabs .nav-link.active {
        background: var(--primary-color);
        color: white;
        border-bottom: 3px solid var(--accent-color);
      }

      .dealer-tabs .nav-tabs .nav-link.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid var(--primary-color);
      }

      /* モバイル用タブスタイル */
      @media (max-width: 768px) {
        .dealer-tabs {
          padding: 0.5rem;
          margin: 0 -0.5rem;
        }

        .dealer-tabs .nav-tabs {
          flex-wrap: nowrap;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none;
          -ms-overflow-style: none;
          padding: 0 0.5rem;
        }

        .dealer-tabs .nav-tabs::-webkit-scrollbar {
          display: none;
        }

        .dealer-tabs .nav-tabs .nav-link {
          padding: 0.5rem 0.75rem;
          font-size: 0.85rem;
          white-space: nowrap;
          min-width: fit-content;
          margin-right: 0.25rem;
          border-radius: 6px;
        }

        .dealer-tabs .nav-tabs .nav-link i {
          font-size: 0.8rem;
        }

        .dealer-tabs .nav-tabs .nav-item {
          flex-shrink: 0;
        }

        .dealer-tabs .nav-tabs .nav-link.active::after {
          display: none;
        }

        .dealer-tabs .nav-tabs .nav-link.active {
          border-bottom: 2px solid var(--accent-color);
        }
      }

      @media (max-width: 576px) {
        .dealer-tabs .nav-tabs .nav-link {
          padding: 0.4rem 0.6rem;
          font-size: 0.8rem;
        }

        .dealer-tabs .nav-tabs .nav-link i {
          font-size: 0.75rem;
        }
      }

      /* 商品登録フォームスタイル */
      .form-label .text-danger {
        font-size: 0.8em;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25);
      }

      .form-control.is-invalid,
      .form-select.is-invalid {
        border-color: #dc3545;
      }

      .form-control.is-valid,
      .form-select.is-valid {
        border-color: #198754;
      }

      .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
      }

      .valid-feedback {
        display: block;
        color: #198754;
        font-size: 0.875em;
        margin-top: 0.25rem;
      }

      /* 最低必要数インライン編集スタイル */
      .min-quantity-container {
        position: relative;
        display: inline-block;
        min-width: 60px;
      }

      .min-quantity-display {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--dark-surface);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--text-primary);
        font-weight: 500;
        min-width: 40px;
        text-align: center;
      }

      .min-quantity-display:hover {
        background: var(--primary-color);
        color: var(--dark-bg);
        border-color: var(--primary-color);
        transform: scale(1.05);
      }

      .min-quantity-input {
        background: var(--dark-card);
        border: 2px solid var(--primary-color);
        border-radius: 6px;
        color: var(--text-primary);
        padding: 0.25rem 0.5rem;
        width: 60px;
        text-align: center;
        font-weight: 500;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
      }

      .min-quantity-input:focus {
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.3);
      }

      /* カテゴリインライン編集スタイル */
      .category-container {
        position: relative;
        display: inline-block;
        min-width: 100px;
      }

      .category-display {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: var(--dark-surface);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--text-primary);
        font-weight: 500;
        min-width: 80px;
        text-align: center;
        font-size: 0.9rem;
      }

      .category-display:hover {
        background: var(--accent-color);
        color: var(--dark-bg);
        border-color: var(--accent-color);
        transform: scale(1.05);
      }

      .category-select {
        background: var(--dark-card);
        border: 2px solid var(--accent-color);
        border-radius: 6px;
        color: var(--text-primary);
        padding: 0.25rem 0.5rem;
        min-width: 100px;
        font-size: 0.9rem;
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
      }

      .category-select:focus {
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.3);
      }

      .category-select option {
        background: var(--dark-card);
        color: var(--text-primary);
      }
    </style>
  </head>
  <body>
    <!-- ナビゲーションバー -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-boxes me-2"></i
          ><span class="d-none d-sm-inline">在庫管理システム</span
          ><span class="d-inline d-sm-none">在庫管理</span>
        </a>

        <!-- モバイル用ハンバーガーメニュー -->
        <button
          class="navbar-toggler d-lg-none"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav ms-auto">
            <button
              class="btn btn-outline-light me-2 mb-2 mb-lg-0 d-none d-md-inline-block"
              onclick="trainMLModel()"
              id="mlTrainBtn"
            >
              <i class="fas fa-brain me-1"></i
              ><span class="d-none d-md-inline">ML訓練</span>
            </button>
            <button
              class="btn btn-outline-light me-2 mb-2 mb-lg-0 d-none d-md-inline-block"
              onclick="exportCSV()"
              id="exportBtn"
            >
              <i class="fas fa-download me-1"></i
              ><span class="d-none d-md-inline">CSV出力</span>
            </button>
            <button
              class="btn btn-outline-light me-2 mb-2 mb-lg-0 d-none d-md-inline-block"
              onclick="exportPDF()"
              id="pdfExportBtn"
            >
              <i class="fas fa-file-pdf me-1"></i
              ><span class="d-none d-md-inline">PDF出力</span>
            </button>
            <button
              class="btn btn-outline-light me-2 mb-2 mb-lg-0"
              onclick="openProductModal()"
            >
              <i class="fas fa-plus me-1"></i
              ><span class="d-none d-md-inline">商品登録</span>
            </button>
            <a href="/alerts" class="btn btn-outline-light me-2 mb-2 mb-lg-0">
              <i class="fas fa-exclamation-triangle me-1"></i
              ><span class="d-none d-md-inline">アラート</span>
            </a>
            <a href="/settings" class="btn btn-outline-light mb-2 mb-lg-0">
              <i class="fas fa-cog me-1"></i
              ><span class="d-none d-md-inline">設定</span>
            </a>
          </div>
        </div>
      </div>
    </nav>

    <div class="main-container">
      <!-- 統計情報 -->
      <div class="row mb-4">
        <!-- デスクトップ用統計情報 -->
        <div class="col-md-3 d-none d-md-block">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="totalProducts">-</div>
            <div class="stats-label">総商品数</div>
          </div>
        </div>
        <div class="col-md-3 d-none d-md-block">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="lowStockCount">-</div>
            <div class="stats-label">在庫不足</div>
          </div>
        </div>
        <div class="col-md-3 d-none d-md-block">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="totalValue">-</div>
            <div class="stats-label">総在庫価値</div>
          </div>
        </div>
        <div class="col-md-3 d-none d-md-block">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="avgPrice">-</div>
            <div class="stats-label">平均単価</div>
          </div>
        </div>

        <!-- モバイル用簡略統計情報 -->
        <div class="col-6 d-block d-md-none">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="mobileTotalProducts">-</div>
            <div class="stats-label">総商品数</div>
          </div>
        </div>
        <div class="col-6 d-block d-md-none">
          <div class="stats-card glow-effect">
            <div class="stats-number" id="mobileLowStockCount">-</div>
            <div class="stats-label">在庫不足</div>
          </div>
        </div>
      </div>

      <!-- 取引会社タブ -->
      <div class="dealer-tabs mb-4">
        <ul class="nav nav-tabs" id="dealerTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link active"
              id="all-tab"
              data-bs-toggle="tab"
              data-bs-target="#all"
              type="button"
              role="tab"
              aria-controls="all"
              aria-selected="true"
              onclick="switchDealerTab('')"
            >
              <i class="fas fa-th-large me-1"></i>全て
            </button>
          </li>
          <!-- 取引会社タブはJavaScriptで動的に生成 -->
        </ul>
      </div>

      <!-- 検索・ソートコントロール -->
      <div class="search-controls mb-4">
        <!-- デスクトップ用コントロール -->
        <div class="row d-none d-md-flex">
          <div class="col-md-6">
            <label class="form-label text-light">検索</label>
            <input
              type="text"
              class="form-control"
              id="searchInput"
              placeholder="商品名、メーカー、カテゴリで検索..."
              oninput="searchProducts()"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label text-light">ソート</label>
            <select class="form-select" id="sortBy" onchange="sortProducts()">
              <option value="product_name">商品名</option>
              <option value="manufacturer">メーカー</option>
              <option value="unit_price">単価</option>
              <option value="current_stock">在庫数</option>
              <option value="min_quantity">最低必要数</option>
              <option value="category">カテゴリ</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label text-light">順序</label>
            <select
              class="form-select"
              id="sortOrder"
              onchange="sortProducts()"
            >
              <option value="asc">昇順</option>
              <option value="desc">降順</option>
            </select>
          </div>
        </div>

        <!-- モバイル用簡略コントロール -->
        <div class="row d-block d-md-none">
          <div class="col-12 mb-3">
            <input
              type="text"
              class="form-control"
              id="mobileSearchInput"
              placeholder="商品名で検索..."
              oninput="searchMobileProducts()"
            />
          </div>
        </div>
      </div>

      <!-- CSVアップロードセクション（デスクトップのみ） -->
      <div class="card mb-4 d-none d-md-block">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-upload me-2"></i>CSVファイルアップロード
          </h5>
        </div>
        <div class="card-body">
          <div class="upload-area" id="uploadArea">
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <h5>CSVファイルをドラッグ&ドロップ</h5>
            <p class="text-muted">または</p>
            <form id="csvUploadForm" enctype="multipart/form-data">
              <div class="row justify-content-center">
                <div class="col-md-6">
                  <select class="form-select mb-3" id="uploadDealer" required>
                    <option value="">取引会社を選択してください</option>
                    <option value="トヨタ">トヨタ</option>
                    <option value="ホンダ">ホンダ</option>
                    <option value="日産">日産</option>
                    <option value="マツダ">マツダ</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <input
                    type="file"
                    class="form-control"
                    id="csvFile"
                    name="file"
                    accept=".csv"
                    required
                  />
                </div>
              </div>
              <div class="row justify-content-center mt-3">
                <div class="col-md-4">
                  <button
                    type="submit"
                    class="btn btn-success w-100"
                    id="uploadBtn"
                  >
                    <i class="fas fa-upload me-1"></i>アップロード
                  </button>
                </div>
              </div>
            </form>
            <small class="text-muted mt-2 d-block">
              取引会社別のCSV形式に対応しています
            </small>
          </div>
        </div>
      </div>

      <!-- 在庫一覧セクション -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>在庫一覧</h5>
        </div>
        <div class="card-body">
          <!-- デスクトップ用テーブル -->
          <div class="table-responsive d-none d-md-block">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>メーカー</th>
                  <th>商品名</th>
                  <th>単価</th>
                  <th>現在在庫</th>
                  <th>最低必要数</th>
                  <th>カテゴリ</th>
                  <th>取引先</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody">
                <!-- JavaScriptで動的に生成 -->
              </tbody>
            </table>
          </div>

          <!-- モバイル用在庫一覧 -->
          <div class="d-block d-md-none">
            <div class="mobile-sort-controls mb-3">
              <div class="row">
                <div class="col-6">
                  <select
                    class="form-select form-select-sm"
                    id="mobileSortBy"
                    onchange="sortMobileTable()"
                  >
                    <option value="product_name">商品名</option>
                    <option value="manufacturer">メーカー</option>
                    <option value="current_stock">在庫数</option>
                    <option value="category">カテゴリ</option>
                  </select>
                </div>
                <div class="col-6">
                  <select
                    class="form-select form-select-sm"
                    id="mobileSortOrder"
                    onchange="sortMobileTable()"
                  >
                    <option value="asc">昇順</option>
                    <option value="desc">降順</option>
                  </select>
                </div>
              </div>
            </div>
            <div id="mobileInventoryList">
              <!-- JavaScriptで動的に生成 -->
            </div>
          </div>
        </div>
      </div>

      <!-- 注文推奨セクション（デスクトップのみ） -->
      <div class="card mb-4 d-none d-md-block">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-lightbulb me-2"></i>注文推奨（機械学習）
          </h5>
        </div>
        <div class="card-body">
          <button
            class="btn btn-warning mb-3"
            onclick="getRecommendations()"
            id="recommendBtn"
          >
            <i class="fas fa-refresh me-1"></i>推奨を更新
          </button>
          <div id="recommendationsContainer">
            <!-- JavaScriptで動的に生成 -->
          </div>
        </div>
      </div>
    </div>

    <!-- アラート表示エリア -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- 商品削除確認モーダル -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">商品削除の確認</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>以下の商品を削除しますか？</p>
            <p><strong id="deleteProductName"></strong></p>
            <p class="text-danger">この操作は取り消せません。</p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              キャンセル
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDelete()"
            >
              削除
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 商品登録モーダル -->
    <div class="modal fade" id="productModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-plus me-2"></i>商品登録
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="productForm">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="productName" class="form-label"
                      >商品名 <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="productName"
                      name="product_name"
                      required
                      placeholder="商品名を入力してください"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="manufacturer" class="form-label"
                      >メーカー <span class="text-danger">*</span></label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="manufacturer"
                      name="manufacturer"
                      required
                      placeholder="メーカー名を入力してください"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="unitPrice" class="form-label"
                      >単価 <span class="text-danger">*</span></label
                    >
                    <div class="input-group">
                      <span class="input-group-text">¥</span>
                      <input
                        type="number"
                        class="form-control"
                        id="unitPrice"
                        name="unit_price"
                        required
                        min="0"
                        step="1"
                        placeholder="0"
                      />
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="currentStock" class="form-label"
                      >現在在庫</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="currentStock"
                      name="current_stock"
                      min="0"
                      step="1"
                      value="0"
                      placeholder="0"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="minQuantity" class="form-label"
                      >最低必要数</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="minQuantity"
                      name="min_quantity"
                      min="0"
                      step="1"
                      value="0"
                      placeholder="0"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="category" class="form-label">カテゴリ</label>
                    <input
                      type="text"
                      class="form-control"
                      id="category"
                      name="category"
                      placeholder="カテゴリを入力してください"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="dealer" class="form-label">取引会社</label>
                    <select class="form-select" id="dealer" name="dealer">
                      <option value="">取引会社を選択してください</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="productCode" class="form-label"
                      >商品コード</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="productCode"
                      name="product_code"
                      placeholder="商品コード（自動生成されます）"
                      readonly
                    />
                    <div class="form-text">商品コードは自動生成されます</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              キャンセル
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="submitProduct()"
              id="submitProductBtn"
            >
              <i class="fas fa-save me-1"></i>登録
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentDealer = "";
      let deleteProductId = null;

      // ページ読み込み時の初期化
      document.addEventListener("DOMContentLoaded", function () {
        loadInventory();
        loadDealers();

        // ドラッグ&ドロップ機能
        setupDragAndDrop();
      });

      // ドラッグ&ドロップ機能の設定
      function setupDragAndDrop() {
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("csvFile");

        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          const files = e.dataTransfer.files;
          if (files.length > 0 && files[0].type === "text/csv") {
            fileInput.files = files;
          }
        });
      }

      // 取引会社一覧の読み込み
      function loadDealers() {
        fetch("/api/dealers")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const uploadDealer = document.getElementById("uploadDealer");
              const productDealer = document.getElementById("dealer");
              const dealerTabs = document.getElementById("dealerTabs");

              // アップロード用の取引会社選択
              if (uploadDealer) {
                uploadDealer.innerHTML =
                  '<option value="">取引会社を選択してください</option>';
                data.dealers.forEach((dealer) => {
                  uploadDealer.innerHTML += `<option value="${dealer}">${dealer}</option>`;
                });
              }

              // 商品登録用の取引会社選択
              if (productDealer) {
                productDealer.innerHTML =
                  '<option value="">取引会社を選択してください</option>';
                data.dealers.forEach((dealer) => {
                  productDealer.innerHTML += `<option value="${dealer}">${dealer}</option>`;
                });
              }

              // 取引会社タブの生成
              if (dealerTabs) {
                // 既存のタブ（「全て」以外）をクリア
                const existingTabs = dealerTabs.querySelectorAll(
                  ".nav-item:not(:first-child)"
                );
                existingTabs.forEach((tab) => tab.remove());

                // 各取引会社のタブを追加
                data.dealers.forEach((dealer) => {
                  const tabItem = document.createElement("li");
                  tabItem.className = "nav-item";
                  tabItem.setAttribute("role", "presentation");

                  const tabButton = document.createElement("button");
                  tabButton.className = "nav-link";
                  tabButton.id = `${dealer}-tab`;
                  tabButton.setAttribute("data-bs-toggle", "tab");
                  tabButton.setAttribute("data-bs-target", `#${dealer}`);
                  tabButton.setAttribute("type", "button");
                  tabButton.setAttribute("role", "tab");
                  tabButton.setAttribute("aria-controls", dealer);
                  tabButton.setAttribute("aria-selected", "false");
                  tabButton.onclick = () => switchDealerTab(dealer);

                  tabButton.innerHTML = `<i class="fas fa-building me-1"></i>${dealer}`;

                  tabItem.appendChild(tabButton);
                  dealerTabs.appendChild(tabItem);
                });
              }
            }
          })
          .catch((error) => {
            console.error("取引会社読み込みエラー:", error);
          });
      }

      // CSVアップロード処理
      document
        .getElementById("csvUploadForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData();
          const fileInput = document.getElementById("csvFile");
          const uploadBtn = document.getElementById("uploadBtn");
          const dealer = document.getElementById("uploadDealer").value;

          if (!fileInput.files[0]) {
            showAlert("warning", "ファイルを選択してください");
            return;
          }

          if (!dealer) {
            showAlert("warning", "取引会社を選択してください");
            return;
          }

          formData.append("file", fileInput.files[0]);
          formData.append("dealer", dealer);

          // ボタンを無効化
          uploadBtn.disabled = true;
          uploadBtn.innerHTML =
            '<span class="loading-spinner me-2"></span>アップロード中...';

          fetch("/api/csv/upload", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showAlert("success", data.message);
                loadInventory();
                fileInput.value = "";
                document.getElementById("uploadDealer").value = "";
              } else {
                showAlert("danger", data.error);
              }
            })
            .catch((error) => {
              showAlert("danger", "アップロードエラー: " + error);
            })
            .finally(() => {
              uploadBtn.disabled = false;
              uploadBtn.innerHTML =
                '<i class="fas fa-upload me-1"></i>アップロード';
            });
        });

      // 取引会社タブ切り替え
      function switchDealerTab(dealer) {
        currentDealer = dealer;

        // 全てのタブのアクティブ状態をリセット
        const allTabs = document.querySelectorAll("#dealerTabs .nav-link");
        allTabs.forEach((tab) => {
          tab.classList.remove("active");
          tab.setAttribute("aria-selected", "false");
        });

        // 選択されたタブをアクティブに
        const selectedTab =
          dealer === ""
            ? document.getElementById("all-tab")
            : document.getElementById(`${dealer}-tab`);

        if (selectedTab) {
          selectedTab.classList.add("active");
          selectedTab.setAttribute("aria-selected", "true");
        }

        loadInventory();
      }

      // 全角・半角を統一する関数
      function normalizeText(text) {
        if (!text) return "";
        return text
          .replace(/[０-９]/g, (s) =>
            String.fromCharCode(s.charCodeAt(0) - 0xfee0)
          )
          .replace(/[Ａ-Ｚａ-ｚ]/g, (s) =>
            String.fromCharCode(s.charCodeAt(0) - 0xfee0)
          )
          .replace(/　/g, " ")
          .replace(/[！-～]/g, (s) =>
            String.fromCharCode(s.charCodeAt(0) - 0xfee0)
          )
          .toLowerCase();
      }

      // 商品検索
      function searchProducts() {
        // モバイルとデスクトップの検索入力を同期
        const desktopSearch = document.getElementById("searchInput");
        const mobileSearch = document.getElementById("mobileSearchInput");

        if (desktopSearch && mobileSearch) {
          if (event && event.target === mobileSearch) {
            desktopSearch.value = mobileSearch.value;
          } else if (event && event.target === desktopSearch) {
            mobileSearch.value = desktopSearch.value;
          }
        }

        loadInventory();
      }

      // モバイル用検索（専用関数）
      function searchMobileProducts() {
        const mobileSearch = document.getElementById("mobileSearchInput");
        const desktopSearch = document.getElementById("searchInput");

        if (mobileSearch && desktopSearch) {
          desktopSearch.value = mobileSearch.value;
        }

        loadInventory();
      }

      // 在庫一覧の読み込み
      function loadInventory() {
        // デスクトップとモバイルの検索入力を統合
        const desktopSearch = document.getElementById("searchInput");
        const mobileSearch = document.getElementById("mobileSearchInput");
        const search =
          (desktopSearch ? desktopSearch.value : "") ||
          (mobileSearch ? mobileSearch.value : "");

        // デスクトップとモバイルのソート設定を統合
        const desktopSortBy = document.getElementById("sortBy");
        const mobileSortBy = document.getElementById("mobileSortBy");
        const sortBy =
          (desktopSortBy ? desktopSortBy.value : "") ||
          (mobileSortBy ? mobileSortBy.value : "product_name");

        const desktopSortOrder = document.getElementById("sortOrder");
        const mobileSortOrder = document.getElementById("mobileSortOrder");
        const sortOrder =
          (desktopSortOrder ? desktopSortOrder.value : "") ||
          (mobileSortOrder ? mobileSortOrder.value : "asc");

        let url = "/api/products?";
        if (currentDealer)
          url += `dealer=${encodeURIComponent(currentDealer)}&`;

        fetch(url)
          .then((response) => response.json())
          .then((products) => {
            // 検索フィルタリング（全角・半角を区別しない）
            let filteredProducts = products;
            if (search) {
              const normalizedSearch = normalizeText(search);
              filteredProducts = products.filter((product) => {
                const normalizedProductName = normalizeText(
                  product.product_name || ""
                );
                const normalizedManufacturer = normalizeText(
                  product.manufacturer || ""
                );
                const normalizedCategory = normalizeText(
                  product.category || ""
                );
                const normalizedDealer = normalizeText(product.dealer || "");

                return (
                  normalizedProductName.includes(normalizedSearch) ||
                  normalizedManufacturer.includes(normalizedSearch) ||
                  normalizedCategory.includes(normalizedSearch) ||
                  normalizedDealer.includes(normalizedSearch)
                );
              });
            }

            // ソート機能（フロントエンドで実装）
            filteredProducts.sort((a, b) => {
              let aValue, bValue;

              switch (sortBy) {
                case "product_name":
                  aValue = a.product_name || "";
                  bValue = b.product_name || "";
                  break;
                case "manufacturer":
                  aValue = a.manufacturer || "";
                  bValue = b.manufacturer || "";
                  break;
                case "unit_price":
                  aValue = parseFloat(a.unit_price) || 0;
                  bValue = parseFloat(b.unit_price) || 0;
                  break;
                case "current_stock":
                  aValue = parseInt(a.current_stock) || 0;
                  bValue = parseInt(b.current_stock) || 0;
                  break;
                case "min_quantity":
                  aValue = parseInt(a.min_quantity) || 0;
                  bValue = parseInt(b.min_quantity) || 0;
                  break;
                case "category":
                  aValue = a.category || "";
                  bValue = b.category || "";
                  break;
                default:
                  aValue = a.product_name || "";
                  bValue = b.product_name || "";
              }

              // 文字列の場合は正規化して比較
              if (typeof aValue === "string" && typeof bValue === "string") {
                aValue = normalizeText(aValue);
                bValue = normalizeText(bValue);
              }

              if (sortOrder === "desc") {
                return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
              } else {
                return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
              }
            });

            // デスクトップ用テーブルの更新
            updateDesktopTable(filteredProducts);

            // モバイル用テーブルの更新
            updateMobileTable(filteredProducts);

            // 統計情報を更新
            updateStats(filteredProducts);
          })
          .catch((error) => {
            showAlert("danger", "在庫データの読み込みエラー: " + error);
          });
      }

      // デスクトップ用テーブルの更新
      function updateDesktopTable(products) {
        const tbody = document.getElementById("inventoryTableBody");
        tbody.innerHTML = "";

        products.forEach((product) => {
          const row = document.createElement("tr");
          row.className = "fade-in";

          const stockClass =
            product.current_stock < product.min_quantity
              ? "stock-low"
              : "stock-ok";

          row.innerHTML = `
                        <td><strong>${product.manufacturer}</strong></td>
                        <td><strong>${product.product_name}</strong></td>
                        <td>¥${product.unit_price.toLocaleString()}</td>
                        <td>
                            <div class="stock-controls">
                                <button class="btn btn-danger" onclick="adjustStock(${
                                  product.id
                                }, -1)" title="在庫を1減らす">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <div class="stock-display ${stockClass}">
                                    ${product.current_stock}
                                </div>
                                <button class="btn btn-success" onclick="adjustStock(${
                                  product.id
                                }, 1)" title="在庫を1増やす">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>
                            <div class="min-quantity-container">
                                <span class="min-quantity-display" id="minQuantity_${
                                  product.id
                                }" onclick="editMinQuantity(${product.id})">
                                    ${product.min_quantity}
                                </span>
                                <input type="number" class="min-quantity-input" id="minQuantityInput_${
                                  product.id
                                }" 
                                       value="${
                                         product.min_quantity
                                       }" min="0" style="display: none;"
                                       onblur="saveMinQuantity(${product.id})" 
                                       onkeypress="handleMinQuantityKeypress(event, ${
                                         product.id
                                       })">
                            </div>
                        </td>
                        <td>
                            <div class="category-container">
                                <span class="category-display" id="category_${
                                  product.id
                                }" onclick="editCategory(${product.id})">
                                    ${product.category || "未設定"}
                                </span>
                                <select class="category-select" id="categorySelect_${
                                  product.id
                                }" 
                                        style="display: none;" onchange="saveCategory(${
                                          product.id
                                        })" 
                                        onblur="cancelCategoryEdit(${
                                          product.id
                                        })">
                                    <option value="">未設定</option>
                                </select>
                            </div>
                        </td>
                        <td>${product.dealer || "-"}</td>
                        <td>
                            <button class="btn delete-btn" onclick="openDeleteModal(${
                              product.id
                            }, '${product.product_name}')" title="商品を削除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
          tbody.appendChild(row);
        });
      }

      // モバイル用在庫一覧の更新（カード形式）
      function updateMobileTable(products) {
        const container = document.getElementById("mobileInventoryList");
        container.innerHTML = "";

        if (products.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-4">
              <i class="fas fa-box-open fa-3x mb-3"></i>
              <p>商品が見つかりませんでした</p>
            </div>
          `;
          return;
        }

        products.forEach((product) => {
          const card = document.createElement("div");
          card.className = "mobile-inventory-card fade-in";

          const stockClass =
            product.current_stock < product.min_quantity
              ? "stock-low"
              : "stock-ok";

          card.innerHTML = `
            <div class="mobile-product-header">
              <h6 class="mobile-product-name">${product.product_name}</h6>
              <p class="mobile-manufacturer">${product.manufacturer || "-"}</p>
            </div>
            <div class="mobile-product-details">
              <span class="mobile-category">${
                product.category || "未設定"
              }</span>
              <div class="mobile-stock-controls">
                <button class="btn btn-danger btn-sm" onclick="adjustStock(${
                  product.id
                }, -1)" title="在庫を1減らす">
                  <i class="fas fa-minus"></i>
                </button>
                <span class="mobile-stock-display ${stockClass}">
                  ${product.current_stock}
                </span>
                <button class="btn btn-success btn-sm" onclick="adjustStock(${
                  product.id
                }, 1)" title="在庫を1増やす">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      // モバイル用ソート機能
      function sortMobileTable() {
        const sortBy = document.getElementById("mobileSortBy").value;
        const sortOrder = document.getElementById("mobileSortOrder").value;

        // デスクトップ用のソート設定も更新
        const desktopSortBy = document.getElementById("sortBy");
        const desktopSortOrder = document.getElementById("sortOrder");

        if (desktopSortBy) desktopSortBy.value = sortBy;
        if (desktopSortOrder) desktopSortOrder.value = sortOrder;

        loadInventory();
      }

      // デスクトップ用ソート機能（モバイルとの同期）
      function sortProducts() {
        const sortBy = document.getElementById("sortBy").value;
        const sortOrder = document.getElementById("sortOrder").value;

        // モバイル用のソート設定も更新
        const mobileSortBy = document.getElementById("mobileSortBy");
        const mobileSortOrder = document.getElementById("mobileSortOrder");

        if (mobileSortBy) mobileSortBy.value = sortBy;
        if (mobileSortOrder) mobileSortOrder.value = sortOrder;

        loadInventory();
      }

      // 商品登録モーダルを開く
      function openProductModal() {
        // フォームをリセット
        document.getElementById("productForm").reset();

        // バリデーション状態をクリア
        const formControls = document.querySelectorAll(
          "#productForm .form-control, #productForm .form-select"
        );
        formControls.forEach((control) => {
          control.classList.remove("is-valid", "is-invalid");
        });

        // 商品コードを自動生成
        generateProductCode();

        // モーダルを表示
        const modal = new bootstrap.Modal(
          document.getElementById("productModal")
        );
        modal.show();
      }

      // 商品コードを自動生成
      function generateProductCode() {
        const manufacturer = document.getElementById("manufacturer").value;
        const timestamp = Date.now().toString().slice(-6);

        if (manufacturer) {
          const prefix = manufacturer.substring(0, 3).toUpperCase();
          document.getElementById(
            "productCode"
          ).value = `${prefix}_${timestamp}`;
        } else {
          document.getElementById("productCode").value = `PRD_${timestamp}`;
        }
      }

      // メーカー名変更時に商品コードを再生成
      document
        .getElementById("manufacturer")
        .addEventListener("input", generateProductCode);

      // 商品登録のバリデーション
      function validateProductForm() {
        let isValid = true;

        // 必須項目のチェック
        const requiredFields = [
          { id: "productName", message: "商品名は必須です" },
          { id: "manufacturer", message: "メーカーは必須です" },
          { id: "unitPrice", message: "単価は必須です" },
        ];

        requiredFields.forEach((field) => {
          const element = document.getElementById(field.id);
          const value = element.value.trim();

          if (!value) {
            element.classList.add("is-invalid");
            element.classList.remove("is-valid");
            showFieldError(element, field.message);
            isValid = false;
          } else {
            element.classList.add("is-valid");
            element.classList.remove("is-invalid");
            clearFieldError(element);
          }
        });

        // 数値項目のチェック
        const numericFields = [
          { id: "unitPrice", message: "単価は0以上の数値で入力してください" },
          {
            id: "currentStock",
            message: "現在在庫は0以上の数値で入力してください",
          },
          {
            id: "minQuantity",
            message: "最低必要数は0以上の数値で入力してください",
          },
        ];

        numericFields.forEach((field) => {
          const element = document.getElementById(field.id);
          const value = parseFloat(element.value);

          if (element.value && (isNaN(value) || value < 0)) {
            element.classList.add("is-invalid");
            element.classList.remove("is-valid");
            showFieldError(element, field.message);
            isValid = false;
          } else if (element.value) {
            element.classList.add("is-valid");
            element.classList.remove("is-invalid");
            clearFieldError(element);
          }
        });

        return isValid;
      }

      // フィールドエラーを表示
      function showFieldError(element, message) {
        clearFieldError(element);
        const errorDiv = document.createElement("div");
        errorDiv.className = "invalid-feedback";
        errorDiv.textContent = message;
        element.parentNode.appendChild(errorDiv);
      }

      // フィールドエラーをクリア
      function clearFieldError(element) {
        const errorDiv = element.parentNode.querySelector(".invalid-feedback");
        if (errorDiv) {
          errorDiv.remove();
        }
      }

      // 商品登録の実行
      function submitProduct() {
        if (!validateProductForm()) {
          showAlert("danger", "入力内容を確認してください");
          return;
        }

        const submitBtn = document.getElementById("submitProductBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-1"></i>登録中...';

        const formData = new FormData(document.getElementById("productForm"));
        const productData = Object.fromEntries(formData.entries());

        // 数値項目を変換
        productData.unit_price = parseFloat(productData.unit_price);
        productData.current_stock = parseInt(productData.current_stock) || 0;
        productData.min_quantity = parseInt(productData.min_quantity) || 0;

        // 空の文字列をnullに変換
        if (!productData.dealer) productData.dealer = null;
        if (!productData.category) productData.category = null;

        fetch("/api/products", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(productData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAlert("success", "商品を登録しました");
              bootstrap.Modal.getInstance(
                document.getElementById("productModal")
              ).hide();
              loadInventory();
              loadDealers(); // 取引会社リストを更新
            } else {
              showAlert("danger", data.error || "商品の登録に失敗しました");
            }
          })
          .catch((error) => {
            showAlert("danger", "登録エラー: " + error);
          })
          .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>登録';
          });
      }

      // 統計情報の更新
      function updateStats(products) {
        const totalProducts = products.length;
        const lowStockCount = products.filter(
          (p) => p.current_stock < p.min_quantity
        ).length;
        const totalValue = products.reduce(
          (sum, p) => sum + p.current_stock * p.unit_price,
          0
        );
        const avgPrice = totalProducts > 0 ? totalValue / totalProducts : 0;

        // デスクトップ用統計情報
        document.getElementById("totalProducts").textContent = totalProducts;
        document.getElementById("lowStockCount").textContent = lowStockCount;
        document.getElementById("totalValue").textContent =
          "¥" + totalValue.toLocaleString();
        document.getElementById("avgPrice").textContent =
          "¥" + Math.round(avgPrice).toLocaleString();

        // モバイル用統計情報
        document.getElementById("mobileTotalProducts").textContent =
          totalProducts;
        document.getElementById("mobileLowStockCount").textContent =
          lowStockCount;
      }

      // 在庫調整（プラス・マイナスボタン）
      function adjustStock(productId, adjustment) {
        // 即座にUIを更新（楽観的更新）
        updateStockDisplay(productId, adjustment);

        fetch(`/api/products/${productId}/stock`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            adjustment: adjustment,
            dealer: "手動調整",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // 成功時は何もしない（既にUIは更新済み）
              showAlert("success", data.message);
            } else {
              // 失敗時は元に戻す
              updateStockDisplay(productId, -adjustment);
              showAlert("danger", data.error);
            }
          })
          .catch((error) => {
            // エラー時は元に戻す
            updateStockDisplay(productId, -adjustment);
            showAlert("danger", "在庫調整エラー: " + error);
          });
      }

      // 在庫表示の即座更新
      function updateStockDisplay(productId, adjustment) {
        // デスクトップ用テーブルの更新
        const rows = document.querySelectorAll("#inventoryTableBody tr");
        rows.forEach((row) => {
          const stockDisplay = row.querySelector(".stock-display");
          const minQuantityDisplay = row.querySelector(".min-quantity-display");
          const adjustButtons = row.querySelectorAll(
            `button[onclick*="adjustStock(${productId}"]`
          );

          if (adjustButtons.length > 0 && stockDisplay && minQuantityDisplay) {
            const currentStock = parseInt(stockDisplay.textContent);
            const newStock = Math.max(0, currentStock + adjustment);
            stockDisplay.textContent = newStock;

            // 在庫状態のクラスを更新
            const minQuantity = parseInt(minQuantityDisplay.textContent);
            if (newStock < minQuantity) {
              stockDisplay.className = "stock-display stock-low";
            } else {
              stockDisplay.className = "stock-display stock-ok";
            }
          }
        });

        // モバイル用カードの更新
        const mobileCards = document.querySelectorAll(
          "#mobileInventoryList .mobile-inventory-card"
        );
        mobileCards.forEach((card) => {
          const adjustButtons = card.querySelectorAll(
            `button[onclick*="adjustStock(${productId}"]`
          );
          const stockDisplay = card.querySelector(".mobile-stock-display");

          if (adjustButtons.length > 0 && stockDisplay) {
            const currentStock = parseInt(stockDisplay.textContent);
            const newStock = Math.max(0, currentStock + adjustment);
            stockDisplay.textContent = newStock;

            // 在庫状態のクラスを更新（簡易的な判定）
            if (newStock < 5) {
              stockDisplay.className = "mobile-stock-display stock-low";
            } else {
              stockDisplay.className = "mobile-stock-display stock-ok";
            }
          }
        });
      }

      // 最低必要数のインライン編集を開始
      function editMinQuantity(productId) {
        const display = document.getElementById(`minQuantity_${productId}`);
        const input = document.getElementById(`minQuantityInput_${productId}`);

        if (display && input) {
          display.style.display = "none";
          input.style.display = "inline-block";
          input.focus();
          input.select();
        }
      }

      // 最低必要数を保存
      function saveMinQuantity(productId) {
        const display = document.getElementById(`minQuantity_${productId}`);
        const input = document.getElementById(`minQuantityInput_${productId}`);

        if (!display || !input) return;

        const newValue = parseInt(input.value);
        if (isNaN(newValue) || newValue < 0) {
          // 無効な値の場合は元の値に戻す
          input.value = display.textContent;
          display.style.display = "inline-block";
          input.style.display = "none";
          return;
        }

        // APIで更新
        fetch(`/api/products/${productId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            min_quantity: newValue,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              display.textContent = newValue;
              showAlert("success", "最低必要数を更新しました");
            } else {
              showAlert("danger", data.error);
              input.value = display.textContent;
            }
          })
          .catch((error) => {
            showAlert("danger", "更新エラー: " + error);
            input.value = display.textContent;
          })
          .finally(() => {
            display.style.display = "inline-block";
            input.style.display = "none";
          });
      }

      // キーボードイベントの処理
      function handleMinQuantityKeypress(event, productId) {
        if (event.key === "Enter") {
          event.preventDefault();
          saveMinQuantity(productId);
        } else if (event.key === "Escape") {
          event.preventDefault();
          const display = document.getElementById(`minQuantity_${productId}`);
          const input = document.getElementById(
            `minQuantityInput_${productId}`
          );
          if (display && input) {
            input.value = display.textContent;
            display.style.display = "inline-block";
            input.style.display = "none";
          }
        }
      }

      // カテゴリのインライン編集を開始
      function editCategory(productId) {
        const display = document.getElementById(`category_${productId}`);
        const select = document.getElementById(`categorySelect_${productId}`);

        if (display && select) {
          // カテゴリ一覧を取得してセレクトボックスに設定
          loadCategoriesForSelect(productId);

          display.style.display = "none";
          select.style.display = "inline-block";
          select.focus();
        }
      }

      // カテゴリ一覧をセレクトボックスに読み込み
      function loadCategoriesForSelect(productId) {
        fetch("/api/categories")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const select = document.getElementById(
                `categorySelect_${productId}`
              );
              const currentCategory = document.getElementById(
                `category_${productId}`
              ).textContent;

              // 既存のオプションをクリア（「未設定」は保持）
              select.innerHTML = '<option value="">未設定</option>';

              data.categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                if (category === currentCategory) {
                  option.selected = true;
                }
                select.appendChild(option);
              });
            }
          })
          .catch((error) => {
            console.error("カテゴリ読み込みエラー:", error);
          });
      }

      // カテゴリを保存
      function saveCategory(productId) {
        const display = document.getElementById(`category_${productId}`);
        const select = document.getElementById(`categorySelect_${productId}`);

        if (!display || !select) return;

        const newCategory = select.value;

        // APIで更新
        fetch(`/api/products/${productId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            category: newCategory || null,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              display.textContent = newCategory || "未設定";
              showAlert("success", "カテゴリを更新しました");
            } else {
              showAlert("danger", data.error);
            }
          })
          .catch((error) => {
            showAlert("danger", "更新エラー: " + error);
          })
          .finally(() => {
            display.style.display = "inline-block";
            select.style.display = "none";
          });
      }

      // カテゴリ編集をキャンセル
      function cancelCategoryEdit(productId) {
        const display = document.getElementById(`category_${productId}`);
        const select = document.getElementById(`categorySelect_${productId}`);

        if (display && select) {
          display.style.display = "inline-block";
          select.style.display = "none";
        }
      }

      // 削除確認モーダルを開く
      function openDeleteModal(productId, productName) {
        deleteProductId = productId;
        document.getElementById("deleteProductName").textContent = productName;
        new bootstrap.Modal(
          document.getElementById("deleteConfirmModal")
        ).show();
      }

      // 商品削除の実行
      function confirmDelete() {
        if (!deleteProductId) return;

        fetch(`/api/products/${deleteProductId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAlert("success", data.message);
              bootstrap.Modal.getInstance(
                document.getElementById("deleteConfirmModal")
              ).hide();
              loadInventory();
            } else {
              showAlert("danger", data.error);
            }
          })
          .catch((error) => {
            showAlert("danger", "削除エラー: " + error);
          });
      }

      // 注文推奨の取得
      function getRecommendations() {
        const btn = document.getElementById("recommendBtn");
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner me-2"></span>更新中...';

        let url = "/api/ml/recommendations";
        if (currentDealer) {
          url += `?dealer=${encodeURIComponent(currentDealer)}`;
        }

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayRecommendations(data.recommendations);
            } else {
              showAlert("warning", data.error);
            }
          })
          .catch((error) => {
            showAlert("danger", "推奨取得エラー: " + error);
          })
          .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-refresh me-1"></i>推奨を更新';
          });
      }

      // 推奨の表示
      function displayRecommendations(recommendations) {
        const container = document.getElementById("recommendationsContainer");

        if (recommendations.length === 0) {
          container.innerHTML =
            '<div class="alert alert-info">現在注文推奨はありません</div>';
          return;
        }

        let html = '<div class="row">';
        recommendations.forEach((rec) => {
          html += `
                    <div class="col-md-6 mb-3">
                        <div class="card recommendation-card priority-${
                          rec.priority
                        } card-hover">
                            <div class="card-body">
                                <h6 class="card-title">${rec.product_name}</h6>
                                <p class="card-text">
                                    <small class="text-muted">${
                                      rec.manufacturer
                                    }</small><br>
                                    <strong>理由:</strong> ${rec.reason}<br>
                                    <strong>推奨数量:</strong> ${
                                      rec.suggested_quantity
                                    }個<br>
                                    <strong>現在在庫:</strong> ${
                                      rec.current_stock
                                    }個<br>
                                    <strong>最低必要数:</strong> ${
                                      rec.min_quantity
                                    }個
                                </p>
                                <span class="badge ${
                                  rec.priority === "high"
                                    ? "bg-danger"
                                    : "bg-warning"
                                }">
                                    ${
                                      rec.priority === "high"
                                        ? "高優先度"
                                        : "中優先度"
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                `;
        });
        html += "</div>";
        container.innerHTML = html;
      }

      // MLモデルの訓練
      function trainMLModel() {
        if (
          confirm("機械学習モデルを訓練しますか？時間がかかる場合があります。")
        ) {
          const btn = document.getElementById("mlTrainBtn");
          btn.disabled = true;
          btn.innerHTML = '<span class="loading-spinner me-2"></span>訓練中...';

          let url = "/api/ml/train";
          if (currentDealer) {
            url += `?dealer=${encodeURIComponent(currentDealer)}`;
          }

          fetch(url, {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showAlert("success", data.message);
              } else {
                showAlert("danger", data.error);
              }
            })
            .catch((error) => {
              showAlert("danger", "訓練エラー: " + error);
            })
            .finally(() => {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-brain me-1"></i>ML訓練';
            });
        }
      }

      // CSVエクスポート
      function exportCSV() {
        const btn = document.getElementById("exportBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<span class="loading-spinner me-2"></span>エクスポート中...';

        let url = "/api/csv/export";
        if (currentDealer) {
          url += `?dealer=${encodeURIComponent(currentDealer)}`;
        }

        fetch(url)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAlert("success", "CSVエクスポートが完了しました");
            } else {
              showAlert("danger", data.error);
            }
          })
          .catch((error) => {
            showAlert("danger", "エクスポートエラー: " + error);
          })
          .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-download me-1"></i>CSV出力';
          });
      }

      // PDFエクスポート
      function exportPDF() {
        const btn = document.getElementById("pdfExportBtn");
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner me-2"></span>出力中...';

        let url = "/api/pdf/export";
        const params = new URLSearchParams();

        if (currentDealer) {
          params.append("dealer", currentDealer);
        }

        // 現在のソート設定を取得
        const sortBy = document.getElementById("sortBy").value;
        const sortOrder = document.getElementById("sortOrder").value;
        params.append("sort_by", sortBy);
        params.append("sort_order", sortOrder);

        if (params.toString()) {
          url += `?${params.toString()}`;
        }

        // ファイルダウンロード用のリンクを作成
        const link = document.createElement("a");
        link.href = url;
        link.download = "";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // ボタンを元に戻す
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-file-pdf me-1"></i>PDF出力';
          showAlert("success", "PDFダウンロードを開始しました");
        }, 1000);
      }

      // アラート表示
      function showAlert(type, message) {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show fade-in`;
        alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

        const container = document.getElementById("alertContainer");
        container.appendChild(alertDiv);

        // 5秒後に自動削除
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      }
    </script>
  </body>
</html>
